# taro+vue3图片的单指缩放 双指缩放 旋转 移动 以及 图片透明区域的裁剪使得和边框贴合

**介绍:**

本文介绍使用微信小程序API+canvas来实现图片的可拖动、放大、缩小和旋转以及透明的区域裁剪，并且通过以上操作生成画布导出指定的比例图片。

业务背景：用户在本地选择图片后可以根据自己的移动旋转缩放场景等 生成不同比例的图片进行保存 类似于美图设计师app的商品图功能以及美图秀秀的抠图合影功能。

**注意点:**

注意：使用前请切换到自己的小程序appid以及页面中通过本地存储放一张图片进行演示。


**事件和api:**

- 实现这些功能主要是用

1. touchstart、touchmove、touchend 触摸事件

2. 计算触摸点到圆心的距离getDistancs

3. 角度计算函数countDeg

4. wx.getImageInfo  wx.createSelectorQuery

5. wx.canvasGetImageData  ctx.drawImage ctx.draw ctx.fillRect ctx.translate canvasToTempFilePath 等等

**实现思路:**

- 主要功能大概分成5个地方：单指缩放 双指缩放 旋转 移动 以及 图片透明区域的裁剪使得和边框贴合

1. 单指缩放主要是移动前记录一下图片半径以及坐标通过移动的点到圆心的距离  * 因为圆心的坐标是相对与父元素定位的 ，注意要减去父元素的OffsetLeft和OffsetTop来计算移动的点到圆心的距离

   最后通过手指滑动的点到圆心的距离与半径的比值作为图片的放大比例 期间主要运用了一个计算触摸点到圆心的距离getDistancs()


2. 双指缩放不同于单指缩放原理是根据两点坐标求出距离(勾股定理)，然后在用移动坐标的距离比就可以求出缩放倍数 代码中startTouches.length !== 2这个判断的原因是防止图片跳动，因为如果你

   两个手指触摸，然后离开一个手指，禁止拖拽的，只有双指都离开后再次触摸才能单指拖拽


3. 旋转也是通过触摸事件根据三角函数求出起始点的角度，然后再求出移动坐标的角度，相减然后加上上一次旋转的角度就等于你当前所需的选择角度 触摸前记录一下坐标以及角度 然后根据角度差计算出

   角度 用过移动后的坐标赋值为移动前坐标 从新计算 其中运用了角度计算函数countDeg() 根据左上 左下 右上 右下 四象限计算角度

4. 移动实现 获取手指点击的某一个图片的点击坐标，并记录在这个图片对象的属性里面 在touchmove事件里 移动的时候记录移动后的坐标，并算出俩次滑动的距离差值，追加给图片对象的left、top、

   x、y上，最后把本次滑动的坐标赋值给touchmove事件里拿到的坐标，作为老坐标。这样就可以实现图片的滑动

5. 图片的裁剪主要用了canvas画布画出图片 通过wx.canvasGetImageData拿到像素点值的数组 注意的是如果你的canvas画布是动态的值canvas的宽高一定不能给小数点 会使得真机返回结果不同

  对于返回的数组你可以理解为rgba4个为一组的值 通过遍历数组找到不是透明的有色彩的上下左右边值 在原本的canvas画布上通过canvasToTempFilePath设置初始x,y坐标以及宽高 进行裁剪这里注意

  如果canvas导出的图片模糊 可以通过获取手机信息的缩放倍率在里面的参数destWidth *缩放倍率 代码里我这里就简单的*3 最后通过裁剪好的图片进行以移动缩放等等 拿到参数通过画布画出来在通过

canvasToTempFilePath导出选择的比例图片进行上传 其中有个要注意的地方因为业务需求最后的图片要背景透明 如果canvas画布设置透明背景setFillStyle('transparent'); 安卓机型会有问题 最

后通过清除画布ctx.fillRect 解决设置canvas透明底色安卓手机显示问题

- 其他

 此项目当中的功能主要还有对坐标的把控以及页面元素的宽高等等值的获取不同机型的元素宽高不同进行调试以及根据图片原始宽高计算缩小图片 拿到值 以及获取页面元素的宽高参数

 最后页面还有一些其他小功能就不一一阐述 有一个小功能还是可以说下的:根据不同的比例画布的大小不同 通过移动或者缩放啊要做一个溢出隐藏 超出画布被外面的白色隐藏 且只隐藏图片边框保留 因为
 
 定位原因脱离文档流和页面布局原因很难处理 最后通过把它们拆开都定位 全部脱离文档流 同时把触摸事件同时赋给 图片 以及 边框实现同步效果 然后通过层级实现只隐藏图片 以上功能详情请看代码

